-- phpMyAdmin SQL Dump
-- version 5.2.0
-- https://www.phpmyadmin.net/
--
-- Хост: 127.0.0.1:3306
-- Время создания: Май 15 2024 г., 11:04
-- Версия сервера: 8.0.30
-- Версия PHP: 7.2.34

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- База данных: `kinoteatr`
--

DELIMITER $$
--
-- Процедуры
--
CREATE DEFINER=`root`@`%` PROCEDURE `AddSeats` (IN `hall_id` INT, IN `roww` INT, IN `start_number` INT, IN `seats_count` INT)   BEGIN
  DECLARE i INT DEFAULT 0;
  WHILE i < seats_count DO
    INSERT INTO `seats`(`hall_id`, `roww`, `number`) VALUES(hall_id, roww, start_number + i);
    SET i = i + 1;
  END WHILE;
END$$

DELIMITER ;

-- --------------------------------------------------------

--
-- Структура таблицы `bookings`
--

CREATE TABLE `bookings` (
  `id` int NOT NULL,
  `user_id` int NOT NULL,
  `session_id` int DEFAULT NULL,
  `seat_id` int NOT NULL,
  `status` enum('Бронь','Куплено') CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT 'Бронь',
  `booking_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `random_code` varchar(16) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

--
-- Дамп данных таблицы `bookings`
--

INSERT INTO `bookings` (`id`, `user_id`, `session_id`, `seat_id`, `status`, `booking_time`, `random_code`) VALUES
(62, 19, 26, 37, 'Бронь', '2024-03-30 19:51:15', '453814ded01b0510'),
(63, 19, 28, 323, 'Бронь', '2024-03-30 19:53:37', 'd52d028701594e17');

--
-- Триггеры `bookings`
--
DELIMITER $$
CREATE TRIGGER `BeforeBookingInsert` BEFORE INSERT ON `bookings` FOR EACH ROW BEGIN
    -- Проверка, что статус равен "Бронь", день является сегодняшним, и до начала сессии осталось менее 20 минут
    IF NEW.status = 'Бронь' AND (SELECT COUNT(*)
                                 FROM sessions
                                 WHERE sessions.id = NEW.session_id
                                   AND DATE(sessions.day) = CURDATE() -- Проверка, что сессия сегодня
                                   AND sessions.time <= NOW() + INTERVAL 20 MINUTE) > 0
    THEN
        -- Вызов ошибки, если условия выполняются
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Нельзя добавлять бронирование с статусом "Бронь" на сегодняшний день менее чем за 20 минут до начала сессии.';
    END IF;
END
$$
DELIMITER ;
DELIMITER $$
CREATE TRIGGER `before_insert_my_table` BEFORE INSERT ON `bookings` FOR EACH ROW BEGIN
    IF NEW.random_code IS NULL OR NEW.random_code = '' THEN
        SET NEW.random_code = SUBSTRING(MD5(RAND()), 1, 16);
    END IF;
END
$$
DELIMITER ;

-- --------------------------------------------------------

--
-- Структура таблицы `movies`
--

CREATE TABLE `movies` (
  `id` int NOT NULL,
  `title` text CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `poster` text NOT NULL,
  `genre` text NOT NULL,
  `full_desc` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

--
-- Дамп данных таблицы `movies`
--

INSERT INTO `movies` (`id`, `title`, `description`, `poster`, `genre`, `full_desc`) VALUES
(1, 'Дюна 2', 'Герцог Пол Атрейдес присоединяется к фременам, чтобы стать Муад Дибом, одновременно пытаясь остановить наступление войны.', 'dune2.jpeg', 'Приключение', 'Повествование «Дюны: Часть вторая» разворачивается, когда Пол Атрейдес вместе со своей семьей и товарищами отступает из суровой местности Арракиса, планеты, где им пришлось яростно бороться за свою жизнь. Их победа над злобными Харконненами обошлась дорогой ценой, и Пол вынашивает намерения вернуть Арракис, чтобы отомстить своему клану.\r\n'),
(2, 'Кунг-фу Панда 4  ', 'После трех смертельных приключений, в которых он победил злодеев мирового уровня благодаря своей непревзойденной храбрости и безумным навыкам боевых искусств, По — Воин Дракона, призван самой судьбой чтобы… отдохнуть наконец.', 'panda4.jpg', 'Мультфильм', '\"Кунг-фу Панда 4: Продолжение приключений\" представляет собой захватывающую историю об искусстве борьбы, дружбе и самопознании. В этой четвертой части легендарный Воин Дракона По вновь вступает в бой, чтобы защитить Долину Мира от новой угрозы. Теперь ему предстоит столкнуться с могущественным злодеем, который хочет погубить мир и завладеть всей его мощью.'),
(5, 'Три богатыря и Пуп земли', 'Алеша открывает портал в мир динозавров и древних людей. Самая кассовая анимация в истории российского проката', '111.jpg', 'Мультфильм', 'По сказкам мы знаем, что было давным-давно, но что было еще давным-давнее? Трем богатырям предстоит узнать ответ на этот вопрос, хоть они его и не задавали. Тут такое началось, что игогошеньки! Горыныч вдруг находит динозаврика, а Алеша Попович с Князем и конем Юлием буквально проваливаются сквозь землю. Теперь надо срочно понять, как вернуть их назад в будущее. А главное, узнать, кто или что такое загадочный Пуп Земли.'),
(7, 'NSDKNSDKVNSDKVNSDVSDNLKVNSLVNSL', 'NSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSL', 'png-clipart-graphic-film-movie-camera-projector-electronics-photography.png', 'Мультфильм', 'NSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSLNSDKNSDKVNSDKVNSDVSDNLKVNSLVNSL');

-- --------------------------------------------------------

--
-- Структура таблицы `seats`
--

CREATE TABLE `seats` (
  `id` int NOT NULL,
  `hall_id` int NOT NULL,
  `roww` int NOT NULL,
  `number` int NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

--
-- Дамп данных таблицы `seats`
--

INSERT INTO `seats` (`id`, `hall_id`, `roww`, `number`) VALUES
(2, 1, 1, 1),
(3, 1, 1, 2),
(4, 1, 1, 3),
(5, 1, 1, 4),
(6, 1, 1, 5),
(7, 1, 1, 6),
(8, 1, 1, 7),
(9, 1, 1, 8),
(10, 1, 1, 9),
(11, 1, 1, 10),
(12, 1, 2, 1),
(13, 1, 2, 2),
(14, 1, 2, 3),
(15, 1, 2, 4),
(16, 1, 2, 5),
(17, 1, 2, 6),
(18, 1, 2, 7),
(19, 1, 2, 8),
(20, 1, 2, 9),
(21, 1, 2, 10),
(22, 1, 3, 1),
(23, 1, 3, 2),
(24, 1, 3, 3),
(25, 1, 3, 4),
(26, 1, 3, 5),
(27, 1, 3, 6),
(28, 1, 3, 7),
(29, 1, 3, 8),
(30, 1, 3, 9),
(31, 1, 3, 10),
(32, 1, 4, 1),
(33, 1, 4, 2),
(34, 1, 4, 3),
(35, 1, 4, 4),
(36, 1, 4, 5),
(37, 1, 4, 6),
(38, 1, 4, 7),
(39, 1, 4, 8),
(40, 1, 4, 9),
(41, 1, 4, 10),
(42, 1, 5, 1),
(43, 1, 5, 2),
(44, 1, 5, 3),
(45, 1, 5, 4),
(46, 1, 5, 5),
(47, 1, 5, 6),
(48, 1, 5, 7),
(49, 1, 5, 8),
(50, 1, 5, 9),
(51, 1, 5, 10),
(52, 1, 6, 1),
(53, 1, 6, 2),
(54, 1, 6, 3),
(55, 1, 6, 4),
(56, 1, 6, 5),
(57, 1, 6, 6),
(58, 1, 6, 7),
(59, 1, 6, 8),
(60, 1, 6, 9),
(61, 1, 6, 10),
(62, 1, 7, 1),
(63, 1, 7, 2),
(64, 1, 7, 3),
(65, 1, 7, 4),
(66, 1, 7, 5),
(67, 1, 7, 6),
(68, 1, 7, 7),
(69, 1, 7, 8),
(70, 1, 7, 9),
(71, 1, 7, 10),
(72, 1, 8, 1),
(73, 1, 8, 2),
(74, 1, 8, 3),
(75, 1, 8, 4),
(76, 1, 8, 5),
(77, 1, 8, 6),
(78, 1, 8, 7),
(79, 1, 8, 8),
(80, 1, 8, 9),
(81, 1, 8, 10),
(82, 1, 9, 1),
(83, 1, 9, 2),
(84, 1, 9, 3),
(85, 1, 9, 4),
(86, 1, 9, 5),
(87, 1, 9, 6),
(88, 1, 9, 7),
(89, 1, 9, 8),
(90, 1, 9, 9),
(91, 1, 9, 10),
(92, 2, 1, 1),
(93, 2, 1, 2),
(94, 2, 1, 3),
(95, 2, 1, 4),
(96, 2, 1, 5),
(97, 2, 1, 6),
(98, 2, 1, 7),
(99, 2, 1, 8),
(100, 2, 1, 9),
(101, 2, 1, 10),
(102, 2, 2, 1),
(103, 2, 2, 2),
(104, 2, 2, 3),
(105, 2, 2, 4),
(106, 2, 2, 5),
(107, 2, 2, 6),
(108, 2, 2, 7),
(109, 2, 2, 8),
(110, 2, 2, 9),
(111, 2, 2, 10),
(112, 2, 3, 1),
(113, 2, 3, 2),
(114, 2, 3, 3),
(115, 2, 3, 4),
(116, 2, 3, 5),
(117, 2, 3, 6),
(118, 2, 3, 7),
(119, 2, 3, 8),
(120, 2, 3, 9),
(121, 2, 3, 10),
(122, 2, 4, 1),
(123, 2, 4, 2),
(124, 2, 4, 3),
(125, 2, 4, 4),
(126, 2, 4, 5),
(127, 2, 4, 6),
(128, 2, 4, 7),
(129, 2, 4, 8),
(130, 2, 4, 9),
(131, 2, 4, 10),
(132, 2, 5, 1),
(133, 2, 5, 2),
(134, 2, 5, 3),
(135, 2, 5, 4),
(136, 2, 5, 5),
(137, 2, 5, 6),
(138, 2, 5, 7),
(139, 2, 5, 8),
(140, 2, 5, 9),
(141, 2, 5, 10),
(142, 2, 6, 1),
(143, 2, 6, 2),
(144, 2, 6, 3),
(145, 2, 6, 4),
(146, 2, 6, 5),
(147, 2, 6, 6),
(148, 2, 6, 7),
(149, 2, 6, 8),
(150, 2, 6, 9),
(151, 2, 6, 10),
(152, 2, 7, 1),
(153, 2, 7, 2),
(154, 2, 7, 3),
(155, 2, 7, 4),
(156, 2, 7, 5),
(157, 2, 7, 6),
(158, 2, 7, 7),
(159, 2, 7, 8),
(160, 2, 7, 9),
(161, 2, 7, 10),
(162, 2, 8, 1),
(163, 2, 8, 2),
(164, 2, 8, 3),
(165, 2, 8, 4),
(166, 2, 8, 5),
(167, 2, 8, 6),
(168, 2, 8, 7),
(169, 2, 8, 8),
(170, 2, 8, 9),
(171, 2, 8, 10),
(172, 2, 9, 1),
(173, 2, 9, 2),
(174, 2, 9, 3),
(175, 2, 9, 4),
(176, 2, 9, 5),
(177, 2, 9, 6),
(178, 2, 9, 7),
(179, 2, 9, 8),
(180, 2, 9, 9),
(181, 2, 9, 10),
(182, 3, 1, 1),
(183, 3, 1, 2),
(184, 3, 1, 3),
(185, 3, 1, 4),
(186, 3, 1, 5),
(187, 3, 1, 6),
(188, 3, 1, 7),
(189, 3, 1, 8),
(190, 3, 1, 9),
(191, 3, 1, 10),
(192, 3, 2, 1),
(193, 3, 2, 2),
(194, 3, 2, 3),
(195, 3, 2, 4),
(196, 3, 2, 5),
(197, 3, 2, 6),
(198, 3, 2, 7),
(199, 3, 2, 8),
(200, 3, 2, 9),
(201, 3, 2, 10),
(202, 3, 3, 1),
(203, 3, 3, 2),
(204, 3, 3, 3),
(205, 3, 3, 4),
(206, 3, 3, 5),
(207, 3, 3, 6),
(208, 3, 3, 7),
(209, 3, 3, 8),
(210, 3, 3, 9),
(211, 3, 3, 10),
(212, 3, 4, 1),
(213, 3, 4, 2),
(214, 3, 4, 3),
(215, 3, 4, 4),
(216, 3, 4, 5),
(217, 3, 4, 6),
(218, 3, 4, 7),
(219, 3, 4, 8),
(220, 3, 4, 9),
(221, 3, 4, 10),
(222, 3, 5, 1),
(223, 3, 5, 2),
(224, 3, 5, 3),
(225, 3, 5, 4),
(226, 3, 5, 5),
(227, 3, 5, 6),
(228, 3, 5, 7),
(229, 3, 5, 8),
(230, 3, 5, 9),
(231, 3, 5, 10),
(232, 3, 6, 1),
(233, 3, 6, 2),
(234, 3, 6, 3),
(235, 3, 6, 4),
(236, 3, 6, 5),
(237, 3, 6, 6),
(238, 3, 6, 7),
(239, 3, 6, 8),
(240, 3, 6, 9),
(241, 3, 6, 10),
(242, 4, 1, 1),
(243, 4, 1, 2),
(244, 4, 1, 3),
(245, 4, 1, 4),
(246, 4, 1, 5),
(247, 4, 1, 6),
(248, 4, 1, 7),
(249, 4, 1, 8),
(250, 4, 1, 9),
(251, 4, 1, 10),
(252, 4, 2, 1),
(253, 4, 2, 2),
(254, 4, 2, 3),
(255, 4, 2, 4),
(256, 4, 2, 5),
(257, 4, 2, 6),
(258, 4, 2, 7),
(259, 4, 2, 8),
(260, 4, 2, 9),
(261, 4, 2, 10),
(262, 4, 3, 1),
(263, 4, 3, 2),
(264, 4, 3, 3),
(265, 4, 3, 4),
(266, 4, 3, 5),
(267, 4, 3, 6),
(268, 4, 3, 7),
(269, 4, 3, 8),
(270, 4, 3, 9),
(271, 4, 3, 10),
(272, 4, 4, 1),
(273, 4, 4, 2),
(274, 4, 4, 3),
(275, 4, 4, 4),
(276, 4, 4, 5),
(277, 4, 4, 6),
(278, 4, 4, 7),
(279, 4, 4, 8),
(280, 4, 4, 9),
(281, 4, 4, 10),
(282, 4, 5, 1),
(283, 4, 5, 2),
(284, 4, 5, 3),
(285, 4, 5, 4),
(286, 4, 5, 5),
(287, 4, 5, 6),
(288, 4, 5, 7),
(289, 4, 5, 8),
(290, 4, 5, 9),
(291, 4, 5, 10),
(292, 4, 6, 1),
(293, 4, 6, 2),
(294, 4, 6, 3),
(295, 4, 6, 4),
(296, 4, 6, 5),
(297, 4, 6, 6),
(298, 4, 6, 7),
(299, 4, 6, 8),
(300, 4, 6, 9),
(301, 4, 6, 10),
(302, 5, 1, 1),
(303, 5, 1, 2),
(304, 5, 1, 3),
(305, 5, 1, 4),
(306, 5, 1, 5),
(307, 5, 1, 6),
(308, 5, 2, 1),
(309, 5, 2, 2),
(310, 5, 2, 3),
(311, 5, 2, 4),
(312, 5, 2, 5),
(313, 5, 2, 6),
(314, 5, 3, 1),
(315, 5, 3, 2),
(316, 5, 3, 3),
(317, 5, 3, 4),
(318, 5, 3, 5),
(319, 5, 3, 6),
(320, 5, 4, 1),
(321, 5, 4, 2),
(322, 5, 4, 3),
(323, 5, 4, 4),
(324, 5, 4, 5),
(325, 5, 4, 6),
(344, 6, 1, 1),
(345, 6, 1, 2),
(346, 6, 1, 3),
(347, 6, 1, 4),
(348, 6, 1, 5),
(349, 6, 1, 6),
(338, 6, 2, 1),
(339, 6, 2, 2),
(340, 6, 2, 3),
(341, 6, 2, 4),
(342, 6, 2, 5),
(343, 6, 2, 6),
(332, 6, 3, 1),
(333, 6, 3, 2),
(334, 6, 3, 3),
(335, 6, 3, 4),
(336, 6, 3, 5),
(337, 6, 3, 6),
(326, 6, 4, 1),
(327, 6, 4, 2),
(328, 6, 4, 3),
(329, 6, 4, 4),
(330, 6, 4, 5),
(331, 6, 4, 6),
(350, 7, 1, 1),
(351, 7, 1, 2),
(352, 7, 1, 3),
(353, 7, 1, 4),
(354, 7, 1, 5),
(355, 7, 2, 1),
(356, 7, 2, 2),
(357, 7, 2, 3),
(358, 7, 2, 4),
(359, 7, 2, 5),
(360, 7, 3, 1),
(361, 7, 3, 2),
(362, 7, 3, 3),
(363, 7, 3, 4),
(364, 7, 3, 5),
(365, 7, 4, 1),
(366, 7, 4, 2),
(367, 7, 4, 3),
(368, 7, 4, 4),
(369, 7, 4, 5),
(370, 7, 5, 1),
(371, 7, 5, 2),
(372, 7, 5, 3),
(373, 7, 5, 4),
(374, 7, 5, 5),
(1, 8, 1, 1),
(376, 8, 1, 2),
(377, 8, 1, 3),
(378, 8, 1, 4),
(379, 8, 1, 5),
(380, 8, 1, 6),
(381, 8, 2, 1),
(382, 8, 2, 2),
(383, 8, 2, 3),
(384, 8, 2, 4),
(385, 8, 2, 5),
(386, 8, 3, 1),
(387, 8, 3, 2),
(388, 8, 3, 3),
(389, 8, 3, 4),
(390, 8, 3, 5),
(391, 8, 4, 1),
(392, 8, 4, 2),
(393, 8, 4, 3),
(394, 8, 4, 4),
(395, 8, 4, 5);

-- --------------------------------------------------------

--
-- Структура таблицы `sessions`
--

CREATE TABLE `sessions` (
  `movie_id` int NOT NULL,
  `id` int NOT NULL,
  `day` date NOT NULL,
  `time` time NOT NULL,
  `hall_id` int NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

--
-- Дамп данных таблицы `sessions`
--

INSERT INTO `sessions` (`movie_id`, `id`, `day`, `time`, `hall_id`) VALUES
(1, 1, '2024-03-23', '16:10:00', 1),
(1, 2, '2024-03-23', '16:20:00', 4),
(1, 3, '2024-03-23', '16:30:00', 6),
(1, 4, '2024-03-24', '16:40:00', 8),
(2, 5, '2024-03-24', '16:40:00', 2),
(2, 6, '2024-03-24', '20:40:00', 3),
(2, 7, '2024-03-24', '10:40:00', 5),
(1, 8, '2024-03-24', '12:40:00', 8),
(1, 9, '2024-03-24', '16:20:00', 6),
(1, 10, '2024-03-25', '16:20:00', 4),
(1, 11, '2024-03-26', '10:20:00', 2),
(1, 12, '2024-03-27', '10:20:00', 1),
(1, 13, '2024-03-23', '20:20:00', 1),
(1, 14, '2024-03-23', '22:20:00', 1),
(1, 15, '2024-03-24', '03:05:27', 1),
(1, 16, '2024-03-24', '03:20:27', 1),
(5, 17, '2024-03-25', '20:10:00', 7),
(5, 18, '2024-03-25', '20:10:00', 7),
(1, 19, '2024-03-30', '18:13:00', 1),
(1, 22, '2024-03-26', '06:12:00', 7),
(1, 23, '2024-03-26', '11:12:00', 3),
(7, 24, '2024-03-26', '00:59:00', 1),
(1, 25, '2024-03-31', '00:48:00', 3),
(2, 26, '2024-03-31', '03:48:00', 1),
(1, 27, '2024-03-31', '17:49:00', 8),
(2, 28, '2024-04-01', '16:49:00', 5),
(2, 29, '2024-03-31', '19:49:00', 4),
(1, 30, '2019-01-01', '18:07:00', 1),
(5, 31, '1111-01-01', '21:12:00', 1);

-- --------------------------------------------------------

--
-- Структура таблицы `users`
--

CREATE TABLE `users` (
  `id` int NOT NULL,
  `mail` text NOT NULL,
  `password` text NOT NULL,
  `role` text NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

--
-- Дамп данных таблицы `users`
--

INSERT INTO `users` (`id`, `mail`, `password`, `role`) VALUES
(14, 'ninini', 'jiojij', 'client'),
(15, 'nininikkkk', 'jiojij', 'client'),
(16, 'nininiokoko', 'jiojij', 'client'),
(17, 'xacho', '123321', 'client'),
(18, 'nik.miner2014@yandex.ru', '123321', 'admin'),
(19, 'nik.miner2014@yanndex.ru', '123321', 'client'),
(20, 'nik.miner2014@yannndex.ru', '123321', 'client'),
(21, 'hello@mail.ru', '123321', 'client'),
(22, 'nik.miner2014@yanndex.run', '123321', 'client'),
(23, 'nik.miner2014@yaanndex.ru', '123321', 'client'),
(24, 'nik.miner2014@yyandex.ru', '123321', 'client');

--
-- Индексы сохранённых таблиц
--

--
-- Индексы таблицы `bookings`
--
ALTER TABLE `bookings`
  ADD PRIMARY KEY (`id`),
  ADD KEY `user_id` (`user_id`),
  ADD KEY `session_id` (`session_id`),
  ADD KEY `seat_id` (`seat_id`);

--
-- Индексы таблицы `movies`
--
ALTER TABLE `movies`
  ADD PRIMARY KEY (`id`);

--
-- Индексы таблицы `seats`
--
ALTER TABLE `seats`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `hall_id` (`hall_id`,`roww`,`number`);

--
-- Индексы таблицы `sessions`
--
ALTER TABLE `sessions`
  ADD PRIMARY KEY (`id`),
  ADD KEY `movie_id` (`movie_id`);

--
-- Индексы таблицы `users`
--
ALTER TABLE `users`
  ADD PRIMARY KEY (`id`);

--
-- AUTO_INCREMENT для сохранённых таблиц
--

--
-- AUTO_INCREMENT для таблицы `bookings`
--
ALTER TABLE `bookings`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=64;

--
-- AUTO_INCREMENT для таблицы `movies`
--
ALTER TABLE `movies`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=8;

--
-- AUTO_INCREMENT для таблицы `seats`
--
ALTER TABLE `seats`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=396;

--
-- AUTO_INCREMENT для таблицы `sessions`
--
ALTER TABLE `sessions`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=32;

--
-- AUTO_INCREMENT для таблицы `users`
--
ALTER TABLE `users`
  MODIFY `id` int NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=25;

--
-- Ограничения внешнего ключа сохраненных таблиц
--

--
-- Ограничения внешнего ключа таблицы `bookings`
--
ALTER TABLE `bookings`
  ADD CONSTRAINT `bookings_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  ADD CONSTRAINT `bookings_ibfk_2` FOREIGN KEY (`session_id`) REFERENCES `sessions` (`id`),
  ADD CONSTRAINT `bookings_ibfk_3` FOREIGN KEY (`seat_id`) REFERENCES `seats` (`id`);

--
-- Ограничения внешнего ключа таблицы `sessions`
--
ALTER TABLE `sessions`
  ADD CONSTRAINT `sessions_ibfk_1` FOREIGN KEY (`movie_id`) REFERENCES `movies` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT;

DELIMITER $$
--
-- События
--
CREATE DEFINER=`root`@`%` EVENT `delete_past_bookings` ON SCHEDULE EVERY 1 MINUTE STARTS '2024-03-24 16:56:31' ON COMPLETION NOT PRESERVE ENABLE DO DELETE b
  FROM bookings b
  JOIN sessions s ON b.session_id = s.id
  WHERE DATE(s.day) = CURDATE() AND s.time <= NOW() + INTERVAL 20 MINUTE$$

DELIMITER ;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
